From fa1962402d33cca83ae77b1daf182e4a305cb29a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Johan=20Sj=C3=B6blom?= <sjoblomj@student.chalmers.se>
Date: Thu, 2 Apr 2020 22:45:31 +0200
Subject: [PATCH] Adding Comments, Image description and Modified time to
 properties dialog

---
 src/uni-exiv2.cpp           | 37 ++++++++++++++++---------------
 src/uni-exiv2.hpp           |  6 ++++--
 src/vnr-properties-dialog.c | 43 +++++++++++++++++++++++++++++++------
 src/vnr-properties-dialog.h |  5 +++--
 4 files changed, 64 insertions(+), 27 deletions(-)

diff --git a/src/uni-exiv2.cpp b/src/uni-exiv2.cpp
index 02fe633..0d14b9f 100644
--- a/src/uni-exiv2.cpp
+++ b/src/uni-exiv2.cpp
@@ -25,10 +25,12 @@
 
 #include "uni-exiv2.hpp"
 
+#define ARRAY_SIZE(array) (sizeof array/sizeof(array[0]))
+
 static Exiv2::Image::AutoPtr cached_image;
 
 extern "C"
-void 
+void
 uni_exif_dictionary_map(void (*callback)(const char*, const char*, void*), void *user_data)
 {
     uint i;

@@ -43,12 +45,10 @@ uni_read_exiv2_map(const char *uri, void (*callback)(const char*, const char*, v
         Exiv2::IptcData &iptcData = image->iptcData();
 
         if ( !exifData.empty() ) {
-            Exiv2::ExifData::const_iterator pos;
-            uint i;
-            ExifDataDictionary dict;
-            for( i=0; i<sizeof(exifDataDictionary)/sizeof(exifDataDictionary[0]); i++ ) {
-                dict = exifDataDictionary[i];
-                
+            for ( uint i = 0; i < ARRAY_SIZE(exifDataDictionary); i++ ) {
+                ExifDataDictionary dict = exifDataDictionary[i];
+
+                Exiv2::ExifData::const_iterator pos;
                 if ( dict.finder == NULL ) {
                     Exiv2::ExifKey key(dict.key);
                     pos = exifData.findKey(key);
@@ -62,14 +62,17 @@ uni_read_exiv2_map(const char *uri, void (*callback)(const char*, const char*, v
             }
         }
 
+        std::string comment = image->comment();
+        if ( ! comment.empty() ) {
+            callback( _("Comment"), comment.c_str(), user_data );
+        }
+
         if ( !iptcData.empty() ) {
-            Exiv2::IptcData::const_iterator pos;
-            uint i;
-            IptcDataDictionary dict;
-            for( i=0; i<sizeof(iptcDataDictionary)/sizeof(iptcDataDictionary[0]); i++ ) {
-                dict = iptcDataDictionary[i];
+            for ( uint i = 0; i < ARRAY_SIZE(iptcDataDictionary); i++ ) {
+                IptcDataDictionary dict = iptcDataDictionary[i];
 
                 Exiv2::IptcKey key(dict.key);
+                Exiv2::IptcData::const_iterator pos;
                 pos = iptcData.findKey(key);
 
                 if ( pos != iptcData.end() ) {
@@ -108,11 +111,11 @@ uni_read_exiv2_to_cache(const char *uri)
 }
 
 extern "C"
-int 
+int
 uni_write_exiv2_from_cache(const char *uri)
 {
     Exiv2::LogMsg::setLevel(Exiv2::LogMsg::mute);
-    
+
     if ( cached_image.get() == NULL ) {
         return 1;
     }
@@ -125,7 +128,7 @@ uni_write_exiv2_from_cache(const char *uri)
 
         image->setMetadata( *cached_image );
         image->writeMetadata();
-        
+
         cached_image->clearMetadata();
         cached_image.reset(NULL);
 
@@ -135,4 +138,4 @@ uni_write_exiv2_from_cache(const char *uri)
     }
 
     return 0;
-}
\ No newline at end of file
+}
diff --git a/src/uni-exiv2.hpp b/src/uni-exiv2.hpp
index edaced9..be7fa10 100644
--- a/src/uni-exiv2.hpp
+++ b/src/uni-exiv2.hpp
@@ -56,7 +56,9 @@ extern "C" {
         { "Exif.Photo.Flash", _("Flash"), NULL },
         { "Exif.Photo.MeteringMode", _("Metering mode"), Exiv2::meteringMode },
         { "Exif.Image.FocalLength", _("Focal length"), Exiv2::focalLength },
-        { "Exif.Image.Software", _("Software"), NULL }
+        { "Exif.Image.Software", _("Software"), NULL },
+        { "Exif.Image.ImageDescription", _("Image description"), NULL },
+        { "Exif.Photo.UserComment", _("User comment"), NULL }
     };
 
     IptcDataDictionary iptcDataDictionary[] = {
@@ -82,4 +84,4 @@ int     uni_write_exiv2_from_cache  (const char *uri);
 #endif /* __cplusplus */
 
 
-#endif /* __UNI_EXIV2__H_ */
\ No newline at end of file
+#endif /* __UNI_EXIV2__H_ */
diff --git a/src/vnr-properties-dialog.c b/src/vnr-properties-dialog.c
index ad055b5..283b6f9 100644
--- a/src/vnr-properties-dialog.c
+++ b/src/vnr-properties-dialog.c
@@ -21,6 +21,9 @@
 #include <glib/gi18n.h>
 #define _(String) gettext (String)
 
+#include <sys/stat.h>
+#include <time.h>
+#include <locale.h>
 #include "vnr-properties-dialog.h"
 #include "vnr-file.h"
 #include "vnr-tools.h"
@@ -104,8 +107,7 @@ vnr_properties_dialog_new (VnrWindow *vnr_win, GtkAction *next_action, GtkAction
     dialog->thumbnail = NULL;
     dialog->vnr_win = vnr_win;
 
-	gtk_activatable_set_related_action (GTK_ACTIVATABLE(dialog->next_button), next_action);
-
+    gtk_activatable_set_related_action (GTK_ACTIVATABLE(dialog->next_button), next_action);
     gtk_activatable_set_related_action (GTK_ACTIVATABLE(dialog->prev_button), prev_action);
 
     gtk_button_set_label (GTK_BUTTON(dialog->next_button), _("_Next"));
@@ -200,6 +202,10 @@ vnr_properties_dialog_init (VnrPropertiesDialog * dialog)
     gtk_label_set_markup(GTK_LABEL(temp_label), _("<b>Height:</b>"));
     gtk_misc_set_alignment (GTK_MISC(temp_label), 0, 0);
     gtk_box_pack_start (GTK_BOX (temp_box), temp_label, FALSE,FALSE,0);
+    temp_label = gtk_label_new(NULL);
+    gtk_label_set_markup(GTK_LABEL(temp_label), _("<b>Modified:</b>"));
+    gtk_misc_set_alignment (GTK_MISC(temp_label), 0, 0);
+    gtk_box_pack_start (GTK_BOX (temp_box), temp_label, FALSE,FALSE,0);
 
 
     temp_box = gtk_vbox_new(FALSE,0);
@@ -225,6 +231,10 @@ vnr_properties_dialog_init (VnrPropertiesDialog * dialog)
     gtk_label_set_selectable (GTK_LABEL(dialog->height_label), TRUE);
     gtk_misc_set_alignment (GTK_MISC(dialog->height_label), 0, 0);
     gtk_box_pack_start (GTK_BOX (temp_box), dialog->height_label, FALSE,FALSE,0);
+    dialog->modified_label = gtk_label_new(NULL);
+    gtk_label_set_selectable (GTK_LABEL(dialog->modified_label), TRUE);
+    gtk_misc_set_alignment (GTK_MISC(dialog->modified_label), 0, 0);
+    gtk_box_pack_start (GTK_BOX (temp_box), dialog->modified_label, FALSE,FALSE,0);
 
     /* Metadata Labels */
 
@@ -345,22 +355,42 @@ vnr_properties_dialog_update_metadata(VnrPropertiesDialog *dialog)
         (void*)dialog);
 }
 
+static void
+vnr_get_modified_time(struct stat filestat, char* buffer, int bufsize)
+{
+    char* saved_locale = strdup(setlocale(LC_TIME, NULL));
+    setlocale(LC_TIME, "");
+    strftime(buffer, bufsize, "%Ec", localtime(&filestat.st_mtime));
+
+    setlocale(LC_TIME, saved_locale);
+    free(saved_locale);
+}
+
 void
 vnr_properties_dialog_update_image(VnrPropertiesDialog *dialog)
 {
-    gchar *width_str, *height_str;
+    gchar *width_str, *height_str, *modified_str;
+
+    struct stat filestat;
+    stat((gchar*)VNR_FILE(dialog->vnr_win->tree->data)->path, &filestat);
+    int bufsize = 80;
+    char buffer[bufsize];
+    vnr_get_modified_time(filestat, buffer, bufsize);
 
     set_new_pixbuf(dialog, uni_image_view_get_pixbuf(UNI_IMAGE_VIEW(dialog->vnr_win->view)));
-    gtk_image_set_from_pixbuf (GTK_IMAGE(dialog->image) , dialog->thumbnail);
+    gtk_image_set_from_pixbuf (GTK_IMAGE(dialog->image), dialog->thumbnail);
 
-    width_str = g_strdup_printf("%i px", dialog->vnr_win->current_image_width);
+    width_str = g_strdup_printf("%i px", dialog->vnr_win->current_image_width);
     height_str = g_strdup_printf("%i px", dialog->vnr_win->current_image_height);
+    modified_str = g_strdup_printf("%s", buffer);
 
     gtk_label_set_text(GTK_LABEL(dialog->width_label), width_str);
     gtk_label_set_text(GTK_LABEL(dialog->height_label), height_str);
+    gtk_label_set_text(GTK_LABEL(dialog->modified_label), modified_str);
 
     g_free(width_str);
     g_free(height_str);
+    g_free(modified_str);
 }
 
 void
@@ -369,12 +399,13 @@ vnr_properties_dialog_clear(VnrPropertiesDialog *dialog)
     set_new_pixbuf(dialog, NULL);
     vnr_properties_dialog_clear_metadata(dialog);
 
-    gtk_label_set_text(GTK_LABEL(dialog->name_label), _("None"));
     gtk_label_set_text(GTK_LABEL(dialog->location_label), _("None"));
+    gtk_label_set_text(GTK_LABEL(dialog->name_label), _("None"));
     gtk_label_set_text(GTK_LABEL(dialog->type_label), _("None"));
     gtk_label_set_text(GTK_LABEL(dialog->size_label), _("None"));
     gtk_label_set_text(GTK_LABEL(dialog->width_label), _("None"));
     gtk_label_set_text(GTK_LABEL(dialog->height_label), _("None"));
+    gtk_label_set_text(GTK_LABEL(dialog->modified_label), _("None"));
 }
 
 void
diff --git a/src/vnr-properties-dialog.h b/src/vnr-properties-dialog.h
index 0a92b5a..489a045 100644
--- a/src/vnr-properties-dialog.h
+++ b/src/vnr-properties-dialog.h
@@ -54,12 +54,13 @@ struct _VnrPropertiesDialog {
     GtkWidget* next_button;
     GtkWidget* prev_button;
 
+    GtkWidget* location_label;
     GtkWidget* name_label;
+    GtkWidget* type_label;
     GtkWidget* size_label;
     GtkWidget* width_label;
     GtkWidget* height_label;
-    GtkWidget* type_label;
-    GtkWidget* location_label;
+    GtkWidget* modified_label;
 
     GdkPixbuf *thumbnail;
 
