From 3bf8dfc840840b04e0e86f75049345185d3a17af Mon Sep 17 00:00:00 2001
From: Marcus Gursch <marcus.gursch@rub.de>
Date: Wed, 5 May 2021 16:16:11 +0200
Subject: [PATCH] swell submenu: full width selection background

---
 WDL/swell/swell-internal.h       |  3 ++-
 WDL/swell/swell-menu-generic.cpp | 24 +++++++++++++++++++-----
 2 files changed, 21 insertions(+), 6 deletions(-)

diff --git a/WDL/swell/swell-internal.h b/WDL/swell/swell-internal.h
index deaa6c0c..9465756a 100644
--- a/WDL/swell/swell-internal.h
+++ b/WDL/swell/swell-internal.h
@@ -1227,7 +1227,8 @@ static void __listview_mergesort_internal(void *base, size_t nmemb, size_t size,
   fd(menu_text_sel, RGB(224,224,224), menu_bg) \
   f(menu_scroll, RGB(64,64,64)) \
   fd(menu_scroll_arrow, RGB(96,96,96), _3dshadow) \
-  fd(menu_submenu_arrow, RGB(96,96,96), _3dshadow) \
+  fd(menu_submenu_arrow, RGB(96,96,96), menu_text) \
+  fd(menu_submenu_arrow_sel, RGB(96,96,96), menu_bg) \
   fd(menubar_bg, RGB(192,192,192), menu_bg) \
   fd(menubar_text, RGB(0,0,0), menu_text) \
   fd(menubar_text_disabled, RGB(224,224,224), menu_text_disabled) \
diff --git a/WDL/swell/swell-menu-generic.cpp b/WDL/swell/swell-menu-generic.cpp
index 445aed09..b53a09ed 100644
--- a/WDL/swell/swell-menu-generic.cpp
+++ b/WDL/swell/swell-menu-generic.cpp
@@ -528,12 +528,13 @@ static LRESULT WINAPI submenuWndProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM
         {
           RECT cr;
           GetClientRect(hwnd,&cr);
-          HBRUSH br=CreateSolidBrush(g_swell_ctheme.menu_bg);
+          HBRUSH br = CreateSolidBrush(g_swell_ctheme.menu_bg);
           HBRUSH br2 = CreateSolidBrushAlpha(g_swell_ctheme.menu_scroll,0.5f);
           HBRUSH br3 = CreateSolidBrush(g_swell_ctheme.menu_scroll_arrow);
           HBRUSH br_submenu_arrow = CreateSolidBrush(g_swell_ctheme.menu_submenu_arrow);
-          HPEN pen=CreatePen(PS_SOLID,0,g_swell_ctheme.menu_shadow);
-          HPEN pen2=CreatePen(PS_SOLID,0,g_swell_ctheme.menu_hilight);
+          HBRUSH br_submenu_arrow_sel = CreateSolidBrush(g_swell_ctheme.menu_submenu_arrow_sel);
+          HPEN pen = CreatePen(PS_SOLID,0,g_swell_ctheme.menu_shadow);
+          HPEN pen2 = CreatePen(PS_SOLID,0,g_swell_ctheme.menu_hilight);
           HGDIOBJ oldbr = SelectObject(ps.hdc,br);
           HGDIOBJ oldpen = SelectObject(ps.hdc,pen2);
           Rectangle(ps.hdc,cr.left,cr.top,cr.right,cr.bottom);
@@ -586,6 +587,7 @@ static LRESULT WINAPI submenuWndProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM
             {
               HBRUSH brs=CreateSolidBrush(g_swell_ctheme.menu_bg_sel);
               RECT r2=r;
+              r2.left = cr.left;
               FillRect(ps.hdc,&r2,brs);
               DeleteObject(brs);
               SetTextColor(ps.hdc,g_swell_ctheme.menu_text_sel);
@@ -656,14 +658,26 @@ static LRESULT WINAPI submenuWndProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM
                  {xp + sz,yp}
                };
                HGDIOBJ oldPen = SelectObject(ps.hdc,GetStockObject(NULL_PEN));
-               SelectObject(ps.hdc,br_submenu_arrow);
+               
+               if (x == menu->sel_vis && !dis)
+                 SelectObject(ps.hdc,br_submenu_arrow_sel);
+               else
+                 SelectObject(ps.hdc,br_submenu_arrow);
+
                Polygon(ps.hdc,pts,3);
 
                SelectObject(ps.hdc,oldPen);
+
+
             }
             if (inf->fState&MF_CHECKED)
             {
-              const int col = dis ? g_swell_ctheme.menu_text_disabled : g_swell_ctheme.menu_text;
+              int col;
+              if (x == menu->sel_vis && !dis)
+                col = g_swell_ctheme.menu_text_sel;
+              else
+                col = dis ? g_swell_ctheme.menu_text_disabled : g_swell_ctheme.menu_text;
+
               HPEN tpen = CreatePen(PS_SOLID,0, col);
               HBRUSH tbr = CreateSolidBrush(col);
               HGDIOBJ oldBrush = SelectObject(ps.hdc,tbr);
